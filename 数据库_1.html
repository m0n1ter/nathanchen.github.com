<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>
        
        数据库 - NathanCHEN
        
    </title>
    
    
    <link href="atom.xml" rel="alternate" title="NathanCHEN" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css"/>
    <link rel="stylesheet" href="asset/css/docs.css"/>
    <link rel="stylesheet" href="asset/css/my.css"/>
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>

</head>
<body class="antialiased hide-extras">

<div class="marketing off-canvas-wrap" data-offcanvas>
    <div class="inner-wrap">


        <nav class="top-bar docs-bar hide-for-small" data-topbar>


            <section class="top-bar-section">
                <div class="row">
                    <div style="position: relative;width:100%;">
                        <div style="position: absolute; width:100%;">
                            <ul id="main-menu" class="left">
                                <li id="menu_item_index"><a href="index.html">HOME</a></li>
                                <li id="menu_item_archives"><a href="archives.html">Archives</a></li>
                                <li id="menu_item_about"><a href="about.html">ABOUT</a></li>
                            </ul>

                            <ul class="right" id="search-wrap">
                                <li>
                                    <form target="_blank" action="http://google.com/search" method="get">
                                        <input type="hidden" name="q" value="site:nathanchen.github.io"/>
                                        <input tabindex="1" type="search" name="q" placeholder="Search"/>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

        </nav>

        <nav class="tab-bar show-for-small">
            <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
                <span> &nbsp; NathanCHEN</span>
            </a>
        </nav>

        <aside class="left-off-canvas-menu">
            <ul class="off-canvas-list">

                <li><a href="index.html">HOME</a></li>
                <li><a href="archives.html">Archives</a></li>
                <li><a href="about.html">ABOUT</a></li>

                <li><label>Categories</label></li>

                
                <li><a href="Java.html">Java</a></li>
                
                <li><a href="JavaScript.html">JavaScript</a></li>
                
                <li><a href="Ngnix.html">Ngnix</a></li>
                
                <li><a href="tomcat.html">tomcat</a></li>
                
                <li><a href="spring.html">spring</a></li>
                
                <li><a href="RabbitMQ.html">RabbitMQ</a></li>
                
                <li><a href="ELK.html">ELK</a></li>
                
                <li><a href="TCP/IP.html">TCP/IP</a></li>
                
                <li><a href="%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.html">源码阅读</a></li>
                
                <li><a href="others.html">others</a></li>
                
                <li><a href="%E6%95%B0%E6%8D%AE%E5%BA%93.html">数据库</a></li>
                
                <li><a href="PAXOS.html">PAXOS</a></li>
                
                <li><a href="%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90Java%20Web%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95.html">深入分析Java Web技术内幕</a></li>
                

            </ul>
        </aside>

        <a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
 <script type="text/javascript">
    $(function () {
        $('#menu_item_index').addClass('is_active');
    });
</script>
<div class="row">
    <div class="large-8 medium-8 columns">
        <div class="markdown-body home-categories">
            
            <div class="article">
                <a class="clearlink" href="14585418716089.html">
                    
                    <h1>Introduction to Data Concurrency and Consistency in a Multiuser Environment</h1>

                    <div class="a-content">
                        
                        <div class="a-content-text">
                            
                            <p>The <strong>serializable</strong> mode of transaction behavior tries to ensure that transactions run in such a way that they appear to be executed one at a time, or serially, rather than concurrently.</p>

<ul>
<li>Dirty reads: A transaction reads data that has been written by another transaction that has not been committed yet</li>
<li>Nonrepeatable reads: A transaction re-reads data it has previously read and finds that another committed transaction has <strong>modified or deleted the data</strong></li>
<li>Phantom reads: A transaction re-runs a query returning a set of rows that satisfies a search condition and finds that another committed transaction has <strong>inserted additional rows</strong> that satisfy the condition.</li>
</ul>

<blockquote>
<p>Oracle offers the read committed and serializable isolation levels, as well as a read-only mode. <strong>Read committed is the default</strong>.</p>
</blockquote>

<h4 id="toc_0">How Oracle Manages Data Concurrency and Consistency</h4>

<h5 id="toc_1">Multiversion Concurrency Control</h5>

<p>Oracle automatically provides read consistency to a query so that <strong>all the data that the query sees comes from a single point in time</strong> (statement-level read consistency). Orable can also provide read consistency to all of the queries in a transaction (transaction-level read consistency).</p>

<p>Oracle uses the information maintained in its <strong>rollback segments</strong> to provide these consistent views. <strong>The rollback segments contain the old values of data that have been changed by uncommitted or recently committed transactions</strong>.</p>

<h5 id="toc_2">Statement-Level Read Consistency</h5>

<p>Oracle always enforces statement-level read consistency. <strong>This gurantees that all the data returned by a single query comes from a single point in time - the time that the query begin</strong>.</p>

<p>As query execution proceesds, only data committed before the query began is visible to the query. The query does not see changes committed after statement execution begins.</p>

<h5 id="toc_3">Transaction-Level Read Consistency</h5>

<p>Oracle also offers the option of enforcing transaction-level read consistency. When a transaction runs in serializable mode, all data accesses reflect the state of the database as of the time the transaction began.</p>

<p>This mean that the data seen by all queries within the same transaction is consistent with respect to a single point in time, <strong>except that queries mde by a serializable transaction do see changes mode by the transaction itself</strong>.</p>

<p>Transactional-level read consistency produces repeatable reads and does not expose a query to phantoms.</p>

<h4 id="toc_4">Comparison of Read Committed and Seriablizable Isolation</h4>

<h5 id="toc_5">Row-Level Locking</h5>

<p>Both read committed and serializable transactions use row-level locking, and both will <strong>wait if they try to change a row updated by an uncommitted concurrent transaction</strong>. The second transaction that tries to update a given row waits for the other transaction to commit or undo and release its lock. If that other transaction rolls back, the waiting transaction, regardless of its isolation mode, can proceed to change the previously locked row as if the other transaction had not existed.</p>

<h5 id="toc_6">Referential Integrity</h5>

<p>Because Orable does not use read locks in either read-consistent or seriablizable transactions. data read by one transaction can be overwritten by another. Transaction that perform database consistency checks at the application level cannot assume that the data they read will remain unchanged during the execution of the transaction even though such changes are not visible to the transaction.</p>

                            
                        </div>
                    </div>
                </a>

                <div class="read-more clearfix">
                    <div class="more-left left">
                        
                        <span class="date">2016/3/21</span>
                        <span>posted in&nbsp;</span> 
                        
                        <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
                        
                    </div>
                    <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                    </div>
                </div>
            </div>
            <!-- article -->
            
            <div class="article">
                <a class="clearlink" href="14584833737979.html">
                    
                    <h1></h1>

                    <div class="a-content">
                        
                        <div class="a-content-text">
                            
                            <h2 id="toc_0">实验一</h2>

<ul>
<li>两次读写操作</li>
</ul>

<pre><code class="language-java">for (int i = 0; i &lt; 2; i++)
{
    try
    {
        Thread.sleep(5000);
    }
    catch (InterruptedException e)
    {
        e.printStackTrace();
    }
    List&lt;WechatUser&gt; wechatUserList = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUserList.size());
    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
    try
    {
        Thread.sleep(1000);
    }
    catch (InterruptedException e)
    {
        e.printStackTrace();
    }

}   
</code></pre>

<h3 id="toc_1">结果：</h3>

<p>2016-03-20 22:13:30 [org.springframework.transaction.annotation.AnnotationTransactionAttributeSource]-[DEBUG] Adding transactional method &#39;WechatRegistServiceImpl.insertUser&#39; with attribute: PROPAGATION_REQUIRED,<mark><strong>ISOLATION_SERIALIZABLE</strong></mark>; &#39;&#39;<br/>
2016-03-20 22:13:30 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Acquired Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] for JDBC transaction<br/>
2016-03-20 22:13:30 [org.springframework.jdbc.datasource.DataSourceUtils]-[DEBUG] <mark><strong>Changing isolation level</strong></mark> of JDBC Connection [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] to <mark><strong>8</strong></mark><br/>
2016-03-20 22:13:30 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[WARN] satart<br/>
2016-03-20 22:13:31 [org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping]-[DEBUG] Looking up handler method for path <mark><strong>/insert.html</strong></mark><br/>
2016-03-20 22:13:31 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Acquired Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] for JDBC transaction<br/>
2016-03-20 22:13:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Creating a new SqlSession</strong></mark><br/>
2016-03-20 22:13:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Registering transaction synchronization for SqlSession <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]</strong></mark><br/>
2016-03-20 22:13:35 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER <br/>
2016-03-20 22:13:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]<br/>
2016-03-20 22:13:35 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：0    用户数量：0</strong></mark><br/>
2016-03-20 22:13:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]</strong></mark> from current transaction<br/>
2016-03-20 22:13:35 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) <br/>
2016-03-20 22:13:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]<br/>
2016-03-20 22:13:35 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   0 条</strong></mark><br/>
2016-03-20 22:13:36 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Creating a new SqlSession</strong></mark><br/>
2016-03-20 22:13:36 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Registering transaction synchronization for SqlSession <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@32358420]</strong></mark><br/>
2016-03-20 22:13:36 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER <br/>
2016-03-20 22:13:41 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]</strong></mark> from current transaction<br/>
2016-03-20 22:13:41 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER <br/>
2016-03-20 22:13:41 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]<br/>
2016-03-20 22:13:41 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：1    用户数量：1</strong></mark><br/>
2016-03-20 22:13:41 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]</strong></mark> from current transaction<br/>
2016-03-20 22:13:41 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) <br/>
2016-03-20 22:13:41 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]<br/>
2016-03-20 22:13:41 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   1 条</strong></mark><br/>
2016-03-20 22:13:42 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization committing SqlSession</strong></mark> <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]</strong></mark><br/>
2016-03-20 22:13:42 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Transaction synchronization deregistering SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]<br/>
2016-03-20 22:13:42 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Transaction synchronization closing SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@4fb26a36]<br/>
2016-03-20 22:13:42 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Initiating transaction commit</strong></mark><br/>
2016-03-20 22:13:42 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] Committing JDBC transaction on Connection [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver]<br/>
2016-03-20 22:13:42 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] &lt;==      <mark><strong>Total: 2</strong></mark><br/>
2016-03-20 22:13:42 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession <mark><strong>[org.apache.ibatis.session.defaults.DefaultSqlSession@32358420]</strong></mark><br/>
2016-03-20 22:13:42 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：0    用户数量：2</strong></mark><br/>
2016-03-20 22:13:42 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@32358420] from current transaction<br/>
2016-03-20 22:13:42 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  Preparing: insert into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) <br/>
2016-03-20 22:13:42 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@32358420]<br/>
2016-03-20 22:13:42 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------写入数据第   0 条<br/>
2016-03-20 22:13:42 [org.springframework.jdbc.datasource.DataSourceUtils]-[DEBUG] <mark><strong>Resetting isolation level</strong></mark> of JDBC Connection [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] to 4<br/>
2016-03-20 22:13:42 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Releasing JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] after transaction<br/>
2016-03-20 22:13:42 [org.springframework.web.servlet.DispatcherServlet]-[DEBUG] Null ModelAndView returned to DispatcherServlet with name &#39;spring&#39;: assuming HandlerAdapter completed request handling<br/>
2016-03-20 22:13:42 [org.springframework.web.servlet.DispatcherServlet]-[DEBUG] Successfully completed request<br/>
2016-03-20 22:13:48 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@32358420] from current transaction</p>

<p>...</p>

<p>2016-03-20 22:13:49 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] Committing JDBC transaction on Connection [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver]<br/>
2016-03-20 22:13:49 [org.springframework.jdbc.datasource.DataSourceUtils]-[DEBUG] <mark><strong>Resetting isolation level of JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] to 4<br/>
2016-03-20 22:13:49 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Releasing JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] after transaction</p>

                            
                        </div>
                    </div>
                </a>

                <div class="read-more clearfix">
                    <div class="more-left left">
                        
                        <span class="date">2016/3/20</span>
                        <span>posted in&nbsp;</span> 
                        
                        <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
                        
                    </div>
                    <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                    </div>
                </div>
            </div>
            <!-- article -->
            
            <div class="article">
                <a class="clearlink" href="14582743812545.html">
                    
                    <h1>数据库事务实验 (ISOLATION_DEFAULT)</h1>

                    <div class="a-content">
                        
                        <div class="a-content-text">
                            
                            <blockquote>
<p>ISOLATION_DEFAULT: Use the default isolation level of the underlying datastore.</p>

<p>The default isolation level in MySQL’s InnoDB is <strong>REPEATABLE READ</strong>.</p>
</blockquote>

<h2 id="toc_0">实验一</h2>

<ul>
<li><code>@transaction</code>标签在class上</li>
<li><code>mapper xml</code>没有配置<code>flushCache</code>以及<code>useCache</code></li>
<li>初始表数据为空</li>
</ul>

<h3 id="toc_1">先执行<code>insert</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_2">再执行<code>select</code>30次，每次休眠1秒</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUser = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUser.size());
</code></pre>

<h3 id="toc_3">结果：</h3>

<p>2016-03-18 12:49:39 [org.springframework.transaction.annotation.AnnotationTransactionAttributeSource]-[DEBUG] <mark><strong>Adding transactional method</strong></mark> &#39;WechatRegistServiceImpl.insertUser&#39; with attribute: <mark><strong>PROPAGATION_REQUIRED</strong></mark>,<mark><strong>ISOLATION_DEFAULT</strong></mark>; &#39;&#39;</p>

<p>2016-03-18 12:49:39 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Creating new transaction</strong></mark> with name [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl.insertUser]: <mark><strong>PROPAGATION_REQUIRED</strong></mark>,<mark><strong>ISOLATION_DEFAULT</strong></mark>; &#39;&#39;</p>

<p>2016-03-18 12:49:40 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Acquired Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] <mark><strong>for JDBC transaction</strong></mark></p>

<p>2016-03-18 12:49:40 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Switching JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] <mark><strong>to manual commit</strong></mark></p>

<p>2016-03-18 12:49:40 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Creating a new SqlSession</strong></mark></p>

<p>2016-03-18 12:49:40 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Registering transaction synchronization for SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353]</p>

<p>2016-03-18 12:49:40 [org.mybatis.spring.transaction.SpringManagedTransaction]-[DEBUG] JDBC Connection [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] <mark><strong>will be managed by Spring</strong></mark></p>

<p>2016-03-18 12:49:40 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) </p>

<p>2016-03-18 12:49:40 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt; Parameters: 1234567890(String), insert(String), null</p>

<p>2016-03-18 12:49:40 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] &lt;==    Updates: 1</p>

<p>2016-03-18 12:49:40 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353]</p>

<p>2016-03-18 12:49:40 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   0 条</strong></mark></p>

<p>2016-03-18 12:49:41 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353] <mark><strong>from current transaction</strong></mark></p>

<p>2016-03-18 12:49:41 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  Preparing: insert into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) </p>

<p>2016-03-18 12:49:41 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt; Parameters: 1234567890(String), insert(String), null</p>

<p>2016-03-18 12:49:41 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] &lt;==    Updates: 1</p>

<p>2016-03-18 12:49:41 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> <br/>
[org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353]<br/>
2016-03-18 12:49:41 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   1 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 12:49:43 [org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping]-[DEBUG] Looking up handler method for path /<mark><strong>select.html</strong></mark></p>

<p>2016-03-18 12:49:43 [org.springframework.transaction.annotation.AnnotationTransactionAttributeSource]-[DEBUG] <mark><strong>Adding transactional method</strong></mark> &#39;WechatRegistServiceImpl.selectUser&#39; with attribute: <mark><strong>PROPAGATION_REQUIRED</strong></mark>,<mark><strong>ISOLATION_DEFAULT</strong></mark>; &#39;&#39;</p>

<p>2016-03-18 12:49:43 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Creating new transaction</strong></mark> with name [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl.selectUser]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT; &#39;&#39;</p>

<p>2016-03-18 12:49:43 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Acquired Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] <mark><strong>for JDBC transaction</strong></mark></p>

<p>2016-03-18 12:49:43 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Switching JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] <mark><strong>to manual commit</strong></mark></p>

<p>2016-03-18 12:49:43 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Creating a new SqlSession</strong></mark></p>

<p>2016-03-18 12:49:43 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Registering transaction synchronization for SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d]</p>

<p>2016-03-18 12:49:43 [org.mybatis.spring.transaction.SpringManagedTransaction]-[DEBUG] <mark><strong>JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] <mark><strong>will be managed by Spring</strong></mark></p>

<p>2016-03-18 12:49:43 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER </p>

<p>2016-03-18 12:49:43 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt; Parameters: </p>

<p>2016-03-18 12:49:43 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] &lt;==      Total: 0</p>

<p>2016-03-18 12:49:43 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> <br/>
[org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d]</p>

<p>2016-03-18 12:49:43 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：0    用户数量：0</strong></mark></p>

<p>2016-03-18 12:49:44 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353] from current transaction</p>

<p>2016-03-18 12:49:44 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) </p>

<p>...</p>

<p>2016-03-18 12:49:44 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d] <mark><strong>from current transaction</strong></mark></p>

<p>2016-03-18 12:49:44 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d]</p>

<p>2016-03-18 12:49:44 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：1    用户数量：0</strong></mark></p>

<p>...</p>

<p>2016-03-18 12:50:00 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization committing SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353]</p>

<p>2016-03-18 12:50:00 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization deregistering SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353]</p>

<p>2016-03-18 12:50:00 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization closing SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@21e3b353]</p>

<p>2016-03-18 12:50:00 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Initiating transaction commit</strong></mark></p>

<p>2016-03-18 12:50:00 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Committing JDBC transaction on Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver]</p>

<p>2016-03-18 12:50:00 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Releasing JDBC Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] after transaction</p>

<p>2016-03-18 12:50:00 [org.springframework.jdbc.datasource.DataSourceUtils]-[DEBUG] <mark><strong>Returning JDBC Connection to DataSource</strong></mark></p>

<p>2016-03-18 12:50:11 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d] <mark><strong>from current transaction</strong></mark></p>

<p>2016-03-18 12:50:11 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d]</p>

<p>2016-03-18 12:50:11 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：28    用户数量：0</strong></mark></p>

<p>2016-03-18 12:50:12 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Fetched SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d] <mark><strong>from current transaction</strong></mark></p>

<p>2016-03-18 12:50:12 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Releasing transactional SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@7a50701d]</p>

<p>2016-03-18 12:50:12 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：29    用户数量：0</strong></mark></p>

<h3 id="toc_4">再发一次<code>select</code>请求</h3>

<p>...</p>

<p>2016-03-18 12:59:34 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER <br/>
2016-03-18 12:59:34 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt; Parameters: <br/>
2016-03-18 12:59:34 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==      Total: 20<br/>
2016-03-18 12:59:34 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@75ab43b7]<br/>
2016-03-18 12:59:34 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：0    用户数量：20</strong></mark><br/>
2016-03-18 12:59:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Fetched SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@75ab43b7] from current transaction<br/>
2016-03-18 12:59:35 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@75ab43b7]<br/>
2016-03-18 12:59:35 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：1    用户数量：20</strong></mark><br/>
2016-03-18 12:59:36 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Fetched SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@75ab43b7] from current transaction<br/>
2016-03-18 12:59:36 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@75ab43b7]<br/>
2016-03-18 12:59:36 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：2    用户数量：20</strong></mark></p>

<h3 id="toc_5">结论</h3>

<ul>
<li>读在一个事务中读的都是缓存，一个事务进行中没有新的请求过去</li>
<li>事务的状态是：<code>PROPAGATION_REQUIRED</code>,<code>ISOLATION_DEFAULT</code></li>
<li>先是<code>Creating a new SqlSession</code>，然后<code>Releasing transactional SqlSession</code>，再有请求则是<code>Fetched SqlSession from current transaction</code></li>
<li><strong>读事务中第一次读，拿到的数据是写事务进行之前数据库的状态；之后拿到的数据都是在缓存中拿到的，无论写事务状态是什么</strong>。</li>
</ul>

<hr/>

<h2 id="toc_6">实验二</h2>

<ul>
<li>@transaction标签在class上</li>
<li>mapper xml没有配置flushCache以及useCache</li>
</ul>

<h3 id="toc_7">先执行<code>insert</code>20次，每次休眠1秒（同一个insert方法）</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_8">再执行<code>insert</code>20次，每次休眠1秒（同一个insert方法）</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_9">结果：</h3>

<p>2016-03-18 13:16:56 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) <br/>
2016-03-18 13:16:56 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt; Parameters: 1234567890(String), insert(String), null<br/>
2016-03-18 13:16:56 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==    Updates: 1<br/>
2016-03-18 13:16:56 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3cb57f97]<br/>
2016-03-18 13:16:56 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   1 条</strong></mark><br/>
2016-03-18 13:16:57 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Fetched SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@302693e9] from current transaction<br/>
2016-03-18 13:16:57 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) <br/>
2016-03-18 13:16:57 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt; Parameters: 1234567890(String), insert(String), null<br/>
2016-03-18 13:16:57 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==    Updates: 1<br/>
2016-03-18 13:16:57 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@302693e9]<br/>
2016-03-18 13:16:57 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   8 条</strong></mark></p>

<h3 id="toc_10">结论</h3>

<ul>
<li>两次写事务并行进行</li>
</ul>

<hr/>

<h2 id="toc_11">实验三</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
<li><code>mapper xml</code>没有配置<code>flushCache</code>以及<code>useCache</code></li>
<li>初始表数据为空</li>
</ul>

<h3 id="toc_12">先执行<code>insert</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_13">再执行<code>select</code>30次，每次休眠1秒</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUser = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUser.size());
</code></pre>

<h3 id="toc_14">结果：</h3>

<p>同实验一</p>

<hr/>

<h2 id="toc_15">实验四</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
<li><code>mapper xml</code>没有配置<code>flushCache</code>以及<code>useCache</code></li>
</ul>

<h3 id="toc_16">先执行<code>insert</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_17">再执行<code>insert</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_18">结果：</h3>

<p>同实验二</p>

<hr/>

<h2 id="toc_19">实验五</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
<li><code>mapper xml</code>设置<code>flushCache=&quot;true&quot; useCache=&quot;false&quot;</code></li>
</ul>

<pre><code class="language-xml">    &lt;select id=&quot;select&quot; resultMap=&quot;BaseResultMap&quot; parameterType=&quot;java.lang.String&quot; flushCache=&quot;true&quot; useCache=&quot;false&quot;&gt;
</code></pre>

<ul>
<li>初始表数据为空</li>
</ul>

<h3 id="toc_20">先执行<code>insert</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_21">再执行<code>select</code>30次，每次休眠1秒</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUser = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUser.size());
</code></pre>

<h3 id="toc_22">结果：</h3>

<p>2016-03-18 13:49:37 [org.springframework.transaction.annotation.AnnotationTransactionAttributeSource]-[DEBUG] <mark><strong>Adding transactional method</strong></mark> &#39;WechatRegistServiceImpl.insertUser&#39; with attribute: <mark><strong>PROPAGATION_REQUIRED</strong></mark>,<mark><strong>ISOLATION_DEFAULT</strong></mark>; &#39;&#39;<br/>
2016-03-18 13:49:37 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Creating new transaction with name</strong></mark> [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl.insertUser]: PROPAGATION_REQUIRED,ISOLATION_DEFAULT; &#39;&#39;<br/>
2016-03-18 13:49:38 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Acquired Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver] for JDBC transaction</p>

<p>...</p>

<p>2016-03-18 13:49:38 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt;  <mark><strong>Preparing: insert</strong></mark> into WECHAT_USER (open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date) values (?, ?, 1, ?, <q>system</q>, now(), <q>system</q>, now()) </p>

<p>2016-03-18 13:49:38 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] ==&gt; Parameters: 1234567890(String), insert(String), null</p>

<p>2016-03-18 13:49:38 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.insert]-[DEBUG] &lt;==    Updates: 1</p>

<p>2016-03-18 13:49:38 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Releasing transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@2e6ab308]</p>

<p>2016-03-18 13:49:38 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   0 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 13:49:39 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   1 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 13:49:40 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   2 条</strong></mark></p>

<p>2016-03-18 13:49:40 [org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping]-[DEBUG] Looking up handler method for path /<mark><strong>select.html</strong></mark></p>

<p>2016-03-18 13:49:40 [org.springframework.transaction.annotation.AnnotationTransactionAttributeSource]-[DEBUG] <mark><strong>Adding transactional method</strong></mark> &#39;WechatRegistServiceImpl.selectUser&#39; with attribute: <mark><strong>PROPAGATION_REQUIRED</strong></mark>,<mark><strong>ISOLATION_DEFAULT</strong></mark>; &#39;&#39;</p>

<p>...</p>

<p>2016-03-18 13:49:40 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER </p>

<p>...</p>

<p>2016-03-18 13:49:40 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：0    用户数量：0</strong></mark></p>

<p>...</p>

<p>2016-03-18 13:49:41 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER </p>

<p>...</p>

<p>2016-03-18 13:49:41 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：1    用户数量：0</strong></mark></p>

<p>...</p>

<p>2016-03-18 13:50:08 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER </p>

<p>2016-03-18 13:50:08 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：28    用户数量：0</strong></mark></p>

<p>2016-03-18 13:50:09 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.select]-[DEBUG] ==&gt;  <mark><strong>Preparing: select</strong></mark> user_id, open_id, user_name, use_yn, authority_value, insert_id, insert_date, modify_id, modify_date from WECHAT_USER </p>

<p>2016-03-18 13:50:09 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：29    用户数量：0</strong></mark></p>

<h3 id="toc_23">结论</h3>

<ul>
<li><strong>读事务中第一次读，拿到的数据是写事务进行之前数据库的状态</strong>。</li>
</ul>

<hr/>

<h2 id="toc_24">实验六</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
</ul>

<h3 id="toc_25">先执行<code>update</code>20次，每次休眠1秒（<code>update</code>同一条数据）</h3>

<pre><code class="language-java">    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_26">再执行<code>update</code>20次，每次休眠1秒（<code>update</code>同一条数据）</h3>

<pre><code class="language-java">    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_27">结果：</h3>

<p>2016-03-18 14:50:30 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.update]-[DEBUG] ==&gt;  <mark><strong>Preparing: update</strong></mark> WECHAT_USER SET open_id = ?, user_name = ?, modify_date = now() where open_id = <q>abc</q> </p>

<p>2016-03-18 14:50:30 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>修改数据：0  结果1</strong></mark></p>

<p>2016-03-18 14:50:31 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] Fetched SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@77e2cc94] from current transaction</p>

<p>2016-03-18 14:50:31 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.update]-[DEBUG] ==&gt;  <mark><strong>Preparing: update</strong></mark> WECHAT_USER SET open_id = ?, user_name = ?, modify_date = now() where open_id = <q>abc</q> </p>

<p>2016-03-18 14:50:31 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>修改数据：1  结果0</strong></mark></p>

<p>2016-03-18 14:50:32 [org.springframework.web.servlet.DispatcherServlet]-[DEBUG] DispatcherServlet with name &#39;spring&#39; processing GET request for [/springtest/update.html]</p>

<p>2016-03-18 14:50:32 [org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping]-[DEBUG] Looking up handler method for path /<mark><strong>update.html</strong></mark></p>

<p>...</p>

<p>2016-03-18 14:50:32 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.update]-[DEBUG] ==&gt;  <mark><strong>Preparing: update</strong></mark> WECHAT_USER SET open_id = ?, user_name = ?, modify_date = now() where open_id = <q>abc</q> </p>

<p>2016-03-18 14:50:32 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>修改数据：2  结果0</strong></mark></p>

<p>...</p>

<p>2016-03-18 14:50:49 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>修改数据：19  结果0</strong></mark></p>

<p>2016-03-18 14:50:50 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization committing SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@77e2cc94]</p>

<p>2016-03-18 14:50:50 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization deregistering SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@77e2cc94]</p>

<p>2016-03-18 14:50:50 [org.mybatis.spring.SqlSessionUtils]-[DEBUG] <mark><strong>Transaction synchronization closing SqlSession</strong></mark> [org.apache.ibatis.session.defaults.DefaultSqlSession@77e2cc94]</p>

<p>2016-03-18 14:50:50 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Initiating transaction commit</strong></mark></p>

<p>2016-03-18 14:50:50 [org.springframework.jdbc.datasource.DataSourceTransactionManager]-[DEBUG] <mark><strong>Committing JDBC transaction on Connection</strong></mark> [jdbc:mysql://localhost:3306/sip?useUnicode=yes&amp;characterEncoding=UTF8, UserName=root@localhost, MySQL-AB JDBC Driver]</p>

<p>...</p>

<p>2016-03-18 14:50:50 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>修改数据：0  结果0</strong></mark></p>

<p>...</p>

<p>2016-03-18 14:50:51 [cn.hao24.mobauto.mapper.wechatusers.WechatUserMapper.update]-[DEBUG] ==&gt;  <mark><strong>Preparing: update</strong></mark> WECHAT_USER SET open_id = ?, user_name = ?, modify_date = now() where open_id = <q>abc</q> </p>

<p>2016-03-18 14:50:51 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>修改数据：1  结果0</strong></mark></p>

<h3 id="toc_28">结论</h3>

<ul>
<li><strong>当两个写事务都是操作同一个数据的时候，第二个写事务会等第一个写事务提交之后才会进行</strong>。</li>
</ul>

<hr/>

<h2 id="toc_29">实验七</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
</ul>

<h3 id="toc_30">先执行<code>update</code>20次，每次休眠1秒（<code>update</code>不同一条数据）</h3>

<pre><code class="language-java">    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_31">再执行<code>update</code>20次，每次休眠1秒（<code>update</code>不同一条数据）</h3>

<pre><code class="language-java">    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_32">结果：</h3>

<p>同实验六</p>

<hr/>

<h2 id="toc_33">实验八</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
</ul>

<h3 id="toc_34">先执行<code>update</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_35">再执行<code>insert</code>20次，每次休眠1秒</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_36">结果：</h3>

<p>先执行<code>update</code>，<code>update</code>事务结束后，执行<code>insert</code></p>

<hr/>

<h2 id="toc_37">实验九</h2>

<ul>
<li><code>@transaction</code>标签在<code>class</code>上</li>
</ul>

<h3 id="toc_38">先执行<code>insert</code>20次，每次休眠1秒（不同insert方法）</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_39">再执行<code>insert</code>20次，每次休眠1秒（不同insert方法）</h3>

<pre><code class="language-java">    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_40">结果：</h3>

<p>并行</p>

<hr/>

<h2 id="toc_41">实验十</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
<li><code>mapper xml</code>设置<code>flushCache=&quot;true&quot; useCache=&quot;false&quot;</code></li>
</ul>

<pre><code class="language-xml">    &lt;select id=&quot;select&quot; resultMap=&quot;BaseResultMap&quot; parameterType=&quot;java.lang.String&quot; flushCache=&quot;true&quot; useCache=&quot;false&quot;&gt;
</code></pre>

<h3 id="toc_42">先执行<code>select + insert</code>20次，每次休眠1秒（同一个<code>select + insert</code>方法）</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUserList = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUserList.size());
    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_43">再执行<code>select + insert</code>20次，每次休眠1秒（同一个<code>select + insert</code>方法）</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUserList = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUserList.size());
    wechatUserMapper.insert(wechatUser);
    logger.info(&quot;----------------写入数据第   &quot; + i + &quot; 条&quot;);
</code></pre>

<h3 id="toc_44">结果：</h3>

<p>2016-03-18 16:17:43 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：5    用户数量：5</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:43 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   5 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:44 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：0    用户数量：0</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:44 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   0 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:44 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：6    用户数量：6</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:44 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   6 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:45 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：1    用户数量：1</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:58 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：19    用户数量：19</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:58 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   19 条</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:58 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>读出数据：14    用户数量：14</strong></mark></p>

<p>...</p>

<p>2016-03-18 16:17:58 [cn.hao24.mobauto.db.service.wechatuser.impl.WechatRegistServiceImpl]-[INFO] ----------------<mark><strong>写入数据第   14 条</strong></mark></p>

<h3 id="toc_45">结论</h3>

<ul>
<li><strong>两个读写事务或并行运行；但是他们对数据库的影响不会作用到彼此，即大家读的都是快照</strong></li>
</ul>

<hr/>

<h2 id="toc_46">实验十一</h2>

<ul>
<li><code>@transaction</code>标签在方法上</li>
<li><code>mapper xml</code>设置<code>flushCache=&quot;true&quot; useCache=&quot;false&quot;</code></li>
</ul>

<pre><code class="language-xml">    &lt;select id=&quot;select&quot; resultMap=&quot;BaseResultMap&quot; parameterType=&quot;java.lang.String&quot; flushCache=&quot;true&quot; useCache=&quot;false&quot;&gt;
</code></pre>

<h3 id="toc_47">先执行<code>select + update</code>20次，每次休眠1秒（同一个<code>select + update</code>方法）</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUserList = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUserList.size());
    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_48">再执行<code>select + update</code>20次，每次休眠1秒（同一个<code>select + update</code>方法）</h3>

<pre><code class="language-java">    List&lt;WechatUser&gt; wechatUserList = wechatUserMapper.select();
    logger.info(&quot;----------------读出数据：&quot; + i + &quot;    用户数量：&quot; + wechatUserList.size());
    int result = wechatUserMapper.update(wechatUser);
    logger.info(&quot;----------------修改数据：&quot; + i + &quot;  结果&quot; + result);
</code></pre>

<h3 id="toc_49">结果：</h3>

<p>两次大事务串行</p>

                            
                        </div>
                    </div>
                </a>

                <div class="read-more clearfix">
                    <div class="more-left left">
                        
                        <span class="date">2016/3/18</span>
                        <span>posted in&nbsp;</span> 
                        
                        <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
                        
                    </div>
                    <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                    </div>
                </div>
            </div>
            <!-- article -->
            
            <div class="article">
                <a class="clearlink" href="14580203304137.html">
                    
                    <h1>MyBatis缓存机制</h1>

                    <div class="a-content">
                        
                        <div class="a-content-text">
                            
                            <h4 id="toc_0">关于<code>Mybatis</code></h4>

<blockquote>
<p><code>MyBatis</code>可以使用简单的<code>XML</code>或注解用于配置和原始映射，将接口和<code>Java</code>的 <code>POJO</code>（<code>Plain Old Java Objects</code>，普通的<code>Java</code>对象）映射成数据库中的记录。</p>
</blockquote>

<h2 id="toc_1">一、为什么需要缓存</h2>

<p>提高对数据库查询的效率，提高应用的性能。</p>

<h2 id="toc_2">二、MyBatis缓存机制整体设计</h2>

<p>MyBatis缓存分为一级和二级，使用顺序：</p>

<pre><code>二级缓存 —&gt; 一级缓存 —&gt; 数据库
</code></pre>

<p><img src="media/14580203304137/14580204411189.jpg" alt=""/></p>

<h2 id="toc_3">三、MyBatis 一级缓存</h2>

<h3 id="toc_4">1、什么是一级缓存</h3>

<p><img src="media/14580203304137/14580204846369.jpg" alt=""/></p>

<p>对于会话（<code>Session</code>）级别的数据缓存，称之为一级缓存。</p>

<h3 id="toc_5">2、一级缓存的生命周期</h3>

<ul>
<li><code>MyBatis</code>在开启一个数据库会话时，会创建一个新的<code>SqlSession</code>对象， <code>SqlSession</code>对象中会有一个新的<code>Executor</code>对象，<code>Executor</code>对象中持有一个新的 <code>PerpetualCache</code>对象；当会话结束时，<code>SqlSession</code>对象及其内部的<code>Executor</code>对象还有<code>PerpetualCache</code>对象也一并释放掉。</li>
<li>如果<code>SqlSession</code>调用了<code>close()</code>方法，会释放掉一级缓存<code>PerpetualCache</code>对象，一级缓存将不可用；</li>
<li>如果<code>SqlSession</code>调用了<code>clearCache()</code>，会清空<code>PerpetualCache</code>对象中的数据，但是该对象仍可使用；</li>
<li><code>SqlSession</code>中执行了任何一个<code>update</code>操作(<code>update()</code>、<code>delete()</code>、 <code>insert()</code>) ，都会清空<code>PerpetualCache</code>对象的数据，但是该对象可以继续使用；</li>
</ul>

<h3 id="toc_6">3、一级缓存工作流程</h3>

<ul>
<li>对于某个查询，<strong>根据<code>statementId</code>, <code>params</code>, <code>rowBounds</code>来构建一个<code>key</code>值</strong>，根据这个<code>key</code>值去缓存<code>Cache</code>中取出对应的<code>key</code>值存储的缓存结果；</li>
<li>判断从<code>Cache</code>中根据特定的<code>key</code>值取的数据数据是否为空，即是否命中；</li>
<li>如果命中，则直接将缓存结果返回；</li>
<li><p>如果没命中：</p>

<ul>
<li>去数据库中查询数据，得到查询结果；</li>
<li>将key和查询到的结果分别作为<code>key</code>, <code>value</code>对存储到<code>Cache</code>中；</li>
<li>将查询结果返回；</li>
</ul></li>
<li><p>结束。</p></li>
</ul>

<h3 id="toc_7">4、一级缓存性能分析</h3>

<ul>
<li><p><code>MyBatis</code>对会话（<code>Session</code>）级别的一级缓存设计的比较简单，就<strong>简单地使用了 <code>HashMap</code>来维护</strong>，并没有对<code>HashMap</code>的容量和大小进行限制。</p></li>
<li><p><strong>一级缓存是一个粗粒度的缓存，没有更新缓存和缓存过期的概念</strong></p></li>
</ul>

<h2 id="toc_8">四、<code>MyBatis</code>二级缓存</h2>

<h3 id="toc_9">1、二级缓存工作模式</h3>

<p>当开一个会话时，一个<code>SqlSession</code>对象会使用一个<code>Executor</code>对象来完成会话操作， <code>MyBatis</code>的二级缓存机制的关键就是对这个<code>Executor</code>对象做文章。如果用户配了<code>cacheEnabled=true</code>，那么<code>MyBatis</code>在为<code>SqlSession</code>对象创建<code>Executor</code>对象时，会对<code>Executor</code>对象加上一个装饰者：<code>CachingExecutor</code>，这时 <code>SqlSession</code>使用<code>CachingExecutor</code>对象来完成操作请求。<code>CachingExecutor</code>对于查询请求，会先判断该查询请求在<code>Application</code>级别的二级缓存中是否有缓存结果，如果有查询结果，则直接返回缓存结果；如果缓存中没有，再交给真正的<code>Executor</code>对象来完成查询操作，之后<code>CachingExecutor</code>会将真正<code>Executor</code>返回的查询结果放置到缓存中，然后在返回给用户。</p>

<h3 id="toc_10">2、二级缓存划分</h3>

<p><code>MyBatis</code>并不是简单地对整个<code>Application</code>就只有一个<code>Cache</code>缓存对象，它将缓存划分的更细，即是<strong><code>Mapper</code>级别的</strong>，即<strong>每一个<code>Mapper</code>都可以拥有一个<code>Cache</code>对象</strong>，具体如下：</p>

<ul>
<li>为每一个<code>Mapper</code>分配一个<code>Cache</code>缓存对象（使用 <code>&lt;cache&gt;</code> 节点配置）；</li>
<li>多个<code>Mapper</code>共用一个<code>Cache</code>缓存对象（使用 <code>&lt;cache-ref&gt;</code> 节点配置）；</li>
</ul>

<p>要想使某条<code>Select</code>查询支持二级缓存，你需要保证：</p>

<ol>
<li><code>MyBatis</code>支持二级缓存的总开关：全局配置变量参数<code>cacheEnabled = true</code></li>
<li>该<code>select</code>语句所在的<code>Mapper</code>，配置了 <code>&lt;cache&gt;</code> 或 <code>&lt;cached-ref&gt;</code>节点，并且有效</li>
<li>该<code>select</code>语句的参数<code>useCache = true</code></li>
</ol>

<h3 id="toc_11">3、二级缓存生命周期</h3>

<p>二级缓存是<code>Application</code>应用级别的缓存，它的是生命周期很长，跟<code>Application</code>的声明周期一样，也就是说它的作用范围是整个<code>Application</code>应用。</p>

<h3 id="toc_12">4、二级缓存禁用与刷新</h3>

<p><code>useCache = &quot;false&quot;</code>可以禁用二级缓存，默认<code>select</code>语句<code>useCache = &quot;true&quot;</code></p>

<p><code>flushCache = &quot;false&quot;</code>即不会刷新缓存，默认<code>flushCache = &quot;true&quot;</code></p>

<h3 id="toc_13">5、Mybatis Cache参数</h3>

<p><code>lushInterval</code>（刷新间隔）可以被设置为任意的正整数，而且它们代表一个合理的毫秒形式的时间段。默认情况是不设置，也就是没有刷新间隔，缓存仅仅调用语句时刷新。</p>

<p><code>size</code>（引用数目）可以被设置为任意正整数，要记住你缓存的对象数目和你运行环境的可用内存资源数目。默认值是1024。</p>

<p><code>readOnly</code>（只读）属性可以被设置为<code>true</code>或<code>false</code>。只读的缓存会给所有调用者返回缓存对象的相同实例。因此这些对象不能被修改。这提供了很重要的性能优势。可读写的缓存会返回缓存对象的拷贝（通过序列化）。这会慢一些，但是安全，因此默认是false。 </p>

<p>如下例子：</p>

<pre><code>&lt;cache  eviction=&quot;FIFO&quot;  flushInterval=&quot;60000&quot;  size=&quot;512&quot;  readOnly=&quot;true&quot;/&gt;
</code></pre>

<p>这个更高级的配置创建了一个<code>FIFO</code>缓存,并每隔60秒刷新,存数结果对象或列表的512个引用,而且返回的对象被认为是只读的,因此在不同线程中的调用者之间修改它们会导致冲突。可用的收回策略有, 默认的是`LRU:</p>

<p><code>LRU</code> – 最近最少使用的：移除最长时间不被使用的对象。<br/>
<code>FIFO</code> – 先进先出：按对象进入缓存的顺序来移除它们。<br/>
<code>SOFT</code> – 软引用：移除基于垃圾回收器状态和软引用规则的对象。<br/>
<code>WEAK</code> – 弱引用：更积极地移除基于垃圾收集器状态和弱引用规则的对象。</p>

<h3 id="toc_14">6、二级缓存的局限性</h3>

<p><code>Mybatis</code>的二级缓存区域以<code>mapper</code>为单位划分，<strong>当一个商品信息变化会将所有商品信息的缓存数据全部清空</strong>，而无法实现当一个商品变化时只刷新该商品的缓存信息而不刷新其它商品的信息，解决此类问题需要在业务层根据需求对数据有针对性缓存。</p>

                            
                        </div>
                    </div>
                </a>

                <div class="read-more clearfix">
                    <div class="more-left left">
                        
                        <span class="date">2016/3/15</span>
                        <span>posted in&nbsp;</span> 
                        
                        <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
                        
                    </div>
                    <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                    </div>
                </div>
            </div>
            <!-- article -->
            
            <div class="article">
                <a class="clearlink" href="14577020064790.html">
                    
                    <h1>事务原理与实践</h1>

                    <div class="a-content">
                        
                        <div class="a-content-text">
                            
                            <h3 id="toc_0">事务简介</h3>

<ul>
<li>事务就是锁和并发的结合体。</li>
<li>所有的针对数据库的一个操作，都可以看做成一个事务。</li>
<li>事务单元之间只有这四种关系：读写、写读、读读、写写</li>
<li>真实业务场景中，如何以最快的速度的方式完成事务和事务之间的关系？又能保证上面四种逻辑的顺序？</li>
<li><p>做法：</p>

<ul>
<li><strong>序列化读写</strong>：<code>ACID</code>中的<code>I</code>破坏了一致性

<ul>
<li>优势：不需要冲突控制</li>
<li>劣势：慢</li>
</ul></li>
<li><p><strong>针对同一单元的访问进行控制（排他锁）</strong>：如果两个事务发生冲突，就串行；如果两个事务不会发生冲突，就并行。</p>

<pre><code>譬如两个事务单元Bob给Smith一百块；李磊给韩梅梅一百块，这两个事务单元完全没有冲突，应该可以并行
</code></pre></li>
<li><p><strong>读写锁分开</strong>：<del><code>读读</code></del>的场景并行；<code>读写</code>、<code>写读</code>、<code>写写</code>串行</p></li>
<li><p><strong><code>MVCC</code></strong>：多版本并发控制<code>Muti-Version Concurrency Control</code>，本质就是<code>Copy on write</code>，每次写都是写一个新的数据，并不是在原位更新，能够做到写不阻塞读，带来<del><code>写读</code></del>、<del><code>读写</code></del>场景的优化。</p>

<ul>
<li>劣势：系统实现的复杂度增加</li>
</ul></li>
</ul></li>
</ul>

<blockquote>
<p>现在只剩下<code>写写</code>才会产生冲突   </p>
</blockquote>

<h3 id="toc_1">事务谁先谁后？</h3>

<p>一个读请求应该读哪一个写之后的数据？</p>

<p><strong>逻辑时间戳</strong>：内存中维护一个数据的自增<code>ID</code>号，本质就是用来说明事务和事务单元之间谁先谁后</p>

<h3 id="toc_2">故障恢复</h3>

<ul>
<li>业务属性不匹配：<code>ACID</code>中的<code>A</code> 回滚，需要记住之前数据没有更改时的状态</li>
<li>系统崩溃</li>
</ul>

<h3 id="toc_3">死锁与死锁检测</h3>

<p>死锁产生的原因：</p>

<ul>
<li>两个线程参与</li>
<li>不同方向上加锁</li>
<li>作用在相同资源</li>
</ul>

<p>解决方案：</p>

<ul>
<li>尽可能不死锁：降低事务隔离级别</li>
<li><strong>碰撞检测</strong>：把所有事务单元维持的所有锁都记下来，终止死锁的一边</li>
<li>等锁超时</li>
</ul>

<h3 id="toc_4">事务的ACID（数据库怎么保证的）</h3>

<ul>
<li>原子性</li>
</ul>

<p>要么全部成功，要么全部失败</p>

<p>只是记录了一个<code>undo</code>日志回滚到之前的版本</p>

<p>Bob给Smith一百块</p>

<pre><code>ver1: Bob有100元 Smith有0元
ver2: Bob有0元 Smith有0元
    (undo：Bob有100元 Smith有0元) &lt;= 数据库回滚段
ver3: Bob有100元 Smith有100元
    (undo：Bob有0元 Smith有0元) &lt;= 数据库回滚段
</code></pre>

<ul>
<li>一致性</li>
</ul>

<pre><code>-- Lock Bob and Smith --
ver1: Bob有100元 Smith有0元
ver2: Bob有0元 Smith有0元
    (undo：Bob有100元 Smith有0元) &lt;= 数据库回滚段
ver3: Bob有0元 Smith有100元
    (undo：Bob有0元 Smith有0元) &lt;= 数据库回滚段
-- Unlock Bob and Smith --
</code></pre>

<ul>
<li>隔离性</li>
</ul>

<p>以性能为理由，对一致性的破坏（各种隔离级别）</p>

<p>隔离性扩展：快照</p>

<ul>
<li>持久性</li>
</ul>

<p>更改便持久的保存在数据库中，只要提交了就不丢</p>

<h3 id="toc_5">快照读的核心做法</h3>

<p>在回滚段中读</p>

<ul>
<li>针对读多写少的情况</li>
</ul>

<p><img src="media/14577020064790/14577073859607.jpg" alt=""/></p>

<blockquote>
<p>大部分数据库已经将<strong>快照读映射到读未提交、读已提交</strong></p>
</blockquote>

<h3 id="toc_6">事务的调优原则</h3>

<ul>
<li>在不影响业务应用的前提下，减小锁的覆盖范围</li>
<li>增加锁上可并行的线程数：读写锁分离、允许并行读取数据</li>
<li>选择正确锁的类型</li>
</ul>

<h3 id="toc_7">Consistent Nonlocking Reads in MySQL</h3>

<p>A consistent read means that InnoDB uses multi-versioning to present to a query a snapshot of the database at a point in time. </p>

<p>The query sees the changes made by transactions that <strong>committed before that point of time</strong>, and no changes made by later or uncommitted transactions. </p>

<p>The exception to this rule is that the query sees the changes made by ealier statements within the same transaction. This exception causes the following anomaly: if you update some rows in a time, a <code>SELECT</code> sees the latest version of the updated rows, but it might also see older versions of any rows. If other sessions simultaneously update the same table, the anomaly means that you might see the table in a state that never existed in the database.</p>

<p>If the transaction isolation level is <code>REPEATABLE READ</code> (the default level), all consistent reads within the same transaction read the snapshot established byu the first such read in that transaction. You can get a fresher snapshot for your queries by committing the current transaction and after that issuing new queries.</p>

<p>With READ COMMITTED isolation level, each consistent read within a transaction sets and reads its own fresh snapshot.</p>

<p>Consistent read is the default mode in which InnoDB processes <code>SELECT</code> statements in <code>READ COMMITTED</code> and <code>REPEATABLE READ</code> isolation levels. A consistent read does not set any locks on the tables it accesses, and therefore other sessions are free to modify those tables at the same time a consistent read is being performed on the table.</p>

<p>Suppose that you are running in the default <code>REPEATABLE READ</code> isolation level. When you issue a consistent read (that is, an ordinary <code>SELECT</code> statement), InnoDB gives your transaction a <strong>timepoint</strong> according to which your query sees the database. <strong>If another transaction deletes a row and commits after your timepoint was assigned, you do not see the row as having been deleted. Inserts and updates are treated similarly</strong>.</p>

<blockquote>
<p>你读数据的时候，数据不会加锁，其他人都能改你读的数据；但是你一直读到的都是最原始的数据，其他人怎么改都不会影响你读到的东西。</p>
</blockquote>

<p>In the following example, session A sees the row inserted by B onluy when B has committed the insert and A has committed as well, so that the timepoint is advanced past the commit of B.</p>

<table>
<thead><th>Session A</th><th>Session B</th></thead>
<tbody>
    <tr>
        <td>
            SET autocommit=0;
        </td>
        <td>
            SET autocommit=0;
        </td>
    </tr>
    <tr>
        <td>
            SELECT * FROM t;  
            # empty set
        </td>
        <td>
            
        </td>
    </tr>
    <tr>
        <td>
            
        </td>
        <td>
            INSERT INTO t VALUES (1, 2);
        </td>
    </tr>
    <tr>
        <td>
            SELECT * FROM t;
            # empty set
        </td>
        <td>
            
        </td>
    </tr>
    <tr>
        <td>
            
        </td>
        <td>
            COMMIT;
        </td>
    </tr>
    <tr>
        <td>
            SELECT * FROM t;
            # empty set
        </td>
        <td>
            
        </td>
    </tr>
    <tr>
        <td>
            COMMIT;
        </td>
        <td>
            
        </td>
    </tr>
    <tr>
        <td>
            SELECT * FROM t;
        </td>
        <td>
            
        </td>
    </tr>
</tbody>
</table>

<p><strong>READ UNCOMMITTED</strong>: <strong>UserA will see the change made by UserB</strong>. This isolation level is called dirty reads, which means that read data is not consistent with other parts of the table or the query, and may not yet have been committed. This isolation level ensures <strong>the quickest performance</strong>, as data is read directly from the table’s blocks with no further processing, verifications or any other validation. <strong>The process is quick and the data is as dirty as it can get</strong>.</p>

<p><strong>READ COMMITTED</strong>: <strong>UserA will not see the change made by UserB</strong>. This is because in the READ COMMITTED isolation level, the rows returned by a query are the rows that were committed when the <strong>query</strong> was started. The change made by UserB was not present when the <strong>query</strong> started, and therefore will not be included in the query result.</p>

<p><strong>REPEATABLE READ</strong>: <strong>UserA will not see the change made by UserB</strong>. This is because in the REPEATABLE READ isolation level, the rows returned by a query are the rows that were committed when the <strong>transaction</strong> was started. The change made by UserB was not present when the <strong>transaction</strong> was started, and therefore will not be included in the query result.</p>

<p>This means that “<strong>All consistent reads within the same transaction read the snapshot established by the first read</strong>” (from MySQL documentation.).</p>

<p><strong>SERIALIZABLE</strong>: This isolation level specifies that <strong>all transactions occur in a completely isolated fashion, meaning as if all transactions in the system were executed serially, one after the other</strong>. The DBMS can execute two or more transactions at the same time only if the illusion of serial execution can be maintained.</p>

<p>In practice, <strong>SERIALIZABLE is similar to REPEATABLE READ</strong>, but <strong>uses a different implementation for each database engine</strong>. <mark>In Oracle, the REPEATABLE READ level is not supported and SERIALIZABLE provides the highest isolation level. This level is similar to REPEATABLE READ, but InnoDB implicitly converts all plain SELECT statements to “SELECT … LOCK IN SHARE MODE</mark>.</p>

<blockquote>
<p>The default isolation level in MySQL’s InnoDB is <strong>REPEATABLE READ</strong>.</p>
</blockquote>

<p>Since old values of row data are required for current queris, databases use a special segment to store old row values and snapshot. MySQL calls this segment a Rollback Segment (Undo Segment in Oracle).</p>

                            
                        </div>
                    </div>
                </a>

                <div class="read-more clearfix">
                    <div class="more-left left">
                        
                        <span class="date">2016/3/11</span>
                        <span>posted in&nbsp;</span> 
                        
                        <span class="posted-in"><a href='%E6%95%B0%E6%8D%AE%E5%BA%93.html'>数据库</a></span>
                        
                    </div>
                    <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                    </div>
                </div>
            </div>
            <!-- article -->
            


            <div class="row">
                <div class="large-6 columns">
                    <p class="text-left" style="padding-top:25px;">
                         <a href="数据库.html">&laquo; Prev Page</a> 
                    </p>
                </div>
                <div class="large-6 columns">
                    <p class="text-right" style="padding-top:25px;">
                         <a href="数据库_2.html">&raquo; Next Page</a> 
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- large 8 -->

 <div class="large-4 medium-4 columns">
    <div class="hide-for-small">
        <div id="sidebar" class="sidebar">
            <div id="site-info" class="site-info">
                
                <h1>NathanCHEN</h1>

                <div class="site-des"></div>
                <div class="social">
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <a class="rss" href="atom.xml" title="RSS">RSS</a>

                </div>
            </div>
            <div id="site-categories" class="side-item ">
                <div class="side-header">
                    <h2>Contact</h2>
                </div>
                <div class="side-content">
                    <ul class="posts-list">
                        <li class="post">
                            <p class="email-addr">tringchen AT gmail.com</p>

                            <p class="email-addr">江苏 · 南京</p>
                        </li>
                    </ul>
                </div>
            </div>
            <div id="site-categories" class="side-item ">
                <div class="side-header">
                    <h2>Categories</h2>
                </div>
                <div class="side-content">

                    <p class="cat-list">
                        
                        <a href="Java.html"><strong>Java</strong></a>
                        
                        <a href="JavaScript.html"><strong>JavaScript</strong></a>
                        
                        <a href="Ngnix.html"><strong>Ngnix</strong></a>
                        
                        <a href="tomcat.html"><strong>tomcat</strong></a>
                        
                        <a href="spring.html"><strong>spring</strong></a>
                        
                        <a href="RabbitMQ.html"><strong>RabbitMQ</strong></a>
                        
                        <a href="ELK.html"><strong>ELK</strong></a>
                        
                        <a href="TCP/IP.html"><strong>TCP/IP</strong></a>
                        
                        <a href="%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.html"><strong>源码阅读</strong></a>
                        
                        <a href="others.html"><strong>others</strong></a>
                        
                        <a href="%E6%95%B0%E6%8D%AE%E5%BA%93.html"><strong>数据库</strong></a>
                        
                        <a href="PAXOS.html"><strong>PAXOS</strong></a>
                        
                        <a href="%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90Java%20Web%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95.html"><strong>深入分析Java Web技术内幕</strong></a>
                        
                    </p>


                </div>
            </div>

            <div id="site-categories" class="side-item">
                <div class="side-header">
                    <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                    <ul class="posts-list">
                        
                        
                        <li class="post">
                            <a href="14594286280881.html">索引的相关知识</a>
                        </li>
                        
                        
                        
                        <li class="post">
                            <a href="14594277278701.html">Java序列化</a>
                        </li>
                        
                        
                        
                        <li class="post">
                            <a href="14594153252228.html">Java传值还是传引用</a>
                        </li>
                        
                        
                        
                        <li class="post">
                            <a href="14592202648535.html">`Local Storage`缓存</a>
                        </li>
                        
                        
                        
                        <li class="post">
                            <a href="14590098445355.html">应用多级缓存模式支撑海量读服务</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                    </ul>
                </div>
            </div>
        </div>
        <!-- sidebar -->
    </div>
    <!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->
 <div class="page-bottom clearfix">
    <div class="row">
        <p class="copyright">Copyright &copy; 2016
            Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp;
            Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
    </div>
</div>
</section>
</div>
</div>




<script src="asset/js/foundation.min.js"></script>
<script>
    $(document).foundation();
    function fixSidebarHeight() {
        var w1 = $('.markdown-body').height();
        var w2 = $('#sidebar').height();
        if (w1 > w2) {
            $('#sidebar').height(w1);
        }
        ;
    }
    $(function () {
        fixSidebarHeight();
    })
    $(window).load(function () {
        fixSidebarHeight();
    });

</script>





</body>
</html>
