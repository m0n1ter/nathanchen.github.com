---
layout: post
title: "NoSQL在SAE中的应用"
category: 
tags: []
---
{% include JB/setup %}

SAE中的SQL

1. 随着NoSQL的兴起，最近有一种观点认为SQL已经过时。虽然SQL有扩展性上的弱势，但MySQL对于绝大多数Web开发者来说，仍是不可或缺的数据存储方式。亚马逊AWS和Google App Engine一开始就没有打算支持MySQL，比如AWS当年因为要推广SimpleDB，而一度忽视了对MySQL的支持。但事实证明，“先进”的设计理念并没有战胜用户“顽固”的使用习惯，所以AWS后来还是推出了RDS。

2. MySQL和memcache还是开发者首选的两个最重要的依赖服务。只有完美地支持他们，才能降低开发者的开发、学习、迁移成本。

3. 如何保证数据库服务的稳定性以及用户之间的隔离性，是最大的挑战。
解决这个问题，一般有两种方案。

	i. 一种方案是依赖虚拟化技术，通过不同层次的虚拟化方案，可以实现不同数据库之间的隔离性。但这种方案的弊端也是显而易见的--成本高。以论坛为例，支持3万个论坛，基本会需要1000台物理机。
	ii. 另一种方案就是将不同用户的MySQL以进程的方式隔离，每个用户一个MySQL实例，这样自然能从一定程度上提高隔离性，但也有缺点：首先是它的成本仍然不够低，其次当实例很多时，加上主库、从库，端口对应关系很难维护，而更重要的是，这种模式的I/O隔离实现有一定难度。

4. SAR通过RDC（Relation Database Cluster）来实现公有云计算平台上数据库的稳定性和隔离性。RDC实际上可以理解为一个数据库中间层，它位于用户和后端时间存储MySQL中间。

5. SAE上所有应用的MySQL请求都是由RDC提供的。RDC的最大特性就是提供了SQL语句预判机制，RDC通过算法分析每条SQL语句的执行效率，当发现该SQL可能损害数据库平台时，就将其拦截，同时将拦截原因以标准mysql error的方式返回给用户。

6. RDC还提出了“并发执行时间”和概念来引导开发者优化自己的表结构和SQL语句，并取代传统MySQL的并发连接数限制，主要原因是传统的连接数限制较为粗鲁，不能区分用户。换句话说，无法区分“SQL优化得好的用户”和“SQL执行性能低下的用户”。而“并发执行时间和”很好地解决了这个问题，它突出一个思想：”对于SQL效率高的用户支持更大的并发，而SQL执行效率低的用户则可能不会获得大的并发“，以鼓励用户优化自己的SQL，提高SQL的执行效率，减少对系统的消耗。

7. 当用户具有良好的SQL编写和使用能力时，就可以获得高并发能力；反之，当开发者滥用SQL语句或者表结构不合理时，就只能得到低并发能力。

8. 目前有一些分布式数据库产品，试图支持自动分裤分表功能，它们大多需要开发者在表结构上指定partition key字段，然后数据库通过该key做分部策略。但这种方式有两个问题：第一要求用户精妙地选择partition key，这会花费用户不小的学习成本。第二，用户需要事先对自己可能使用的容量做预估。

9. SAE的NoSQL服务：MemcacheX是SAE的分布式缓存系统，Rank是SAE为了满足排行榜需求而开发的Top排行榜服务，Counter则是分布式计算器服务。而KVDB系统为开发者提高支持动态扩展的键值式数据存储服务。

10. 开发KVDB的需求：

	- 本地存储引擎可换：要求我们的实现不应该绑定在某个存储引擎上，而应该更集中于上层的框架
	- 任意模块都可以水平扩展，我们不希望有一个single master的东西存在。
	- 支持读写分离
	- 支持前缀查找
	- 支持第二索引：不仅仅可以通过key查找value，还可以通过value反查key。
	- 支持认证

11. 每次请求前，client都需要向meta server请求得到appname-key到实际存储节点的映射关系。获取映射信息后，client直接向该节点进行数据请求。meta server实际存储的是映射关系。meta server始终处于只读状态，而映射关系的写入则是从Internal DB操作。后端的实际存储引擎可替换、按组分布，每一组都由一个主库和若干从库库组成。

12. KVDB有两个很关键的问题需要解决：第一，多个meta server如何保证他们映射关系的一致性；第二，后端存储的重平衡。

13. 传统的保证数据一致性的方式可以选择ZooKeeper，因为映射关系的更改操作直接写入Internal DB，而meta server只相当于Internal DB里数据的一种cache，所以每个meta server都不停地向Internal DB检查自身数据的同步情况。如果所有meta server都和Internal DB中的映射关系同步，那么一定说明所有meta server数据一致；反之，一旦出现某个meta server和Internal DB一段时间内持续同步不成功，则该meta server自动退出服务。

14. 但是，一旦Internal DB出现故障，比如磁盘损坏或者网络故障，将会导致一个致命的问题：所有meta server都因为和InternalDB不同步出现问题，而选择自动下线，于是使得没有任何meta server提供服务，进而影响整个KVDB的使用。
为了解决这个问题，KVDB自行设计了基于PAXOS的网络协议，每个meta server在退出服务前，都向所有的meta server（假设N个）发起一轮会话，询问是否允许自己推出服务，在得到N/2+1的同意后，则自动退出服务；否则根据拒绝信息里含的数据选择是否持续询问或者接受其他人的会话。

15. 因为云计算无法预知用户的使用量，所以即使在用户申请服务时进行基于权重的分配，仍然不可避免在服务运行一段时间后，平台出现不平衡的情况。

16. 对于KVDB而言，不平衡主要体现在两个维度：磁盘使用量和节点负载。

17. KVDB开发了一套基于严格数学理论的判断重平衡方法。
	
	数学期望表示一个系统的均值，
	均方差表示系统里的值和均值的偏离程度。
如果大多数机器负载都很高，表示负载的数学期望很高，那么KVDB需要做的并不是重平衡而是扩容，这时需要将新的节点加入服务，以缓解现在系统压力；
而如果大多数机器的负载都很低，只有个别机器的负载很高，也就是负载的数学期望不高，而均方差很高，这表明系统并没有扩容的迫切要求，而真正需要做的是重平衡。

