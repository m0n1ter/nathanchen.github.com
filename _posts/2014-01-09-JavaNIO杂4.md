---
layout: post
title: "Java NIO杂4"
category: Reading Notes
tags: ["读文章", "Java"]
---
{% include JB/setup %}

Java NIO中的SocketChannel是一个连接到TCP网络套接字的通道。可以通过以下两种方式创建SocketChannel：

- 打开一个SocketChannel并连接到互联网上的某台服务器
- 一个新连接到达ServerSocketChannel时，会创建一个SocketChannel

##### 打开SocketChannel

	SocketChannel socketChannel = SocketChannel.open();
	socketChannel.connect(new InetSocketAddress("http://jenkov.com", 80));

##### 关闭SocketChannel

	socketChannel.close();

##### 从SocketChannel读取数据

	ByteBuffer buf = ByteBuffer.allocate(48);
	int bytesRead = socketChannel.read(buf);

首先，分配一个Buffer。从SocketChannel读取到的数据将会放到这个Buffer中。

然后，调用`SocketChannel.read()`。该方法将数据从SocketChannel读到Buffer中。

read()方法返回的int值表示读了多少字节进Buffer里。如果返回的是-1，表示已经读到了流的末尾（连接关闭了）。

##### 写入SocketChannel

写数据到SocketChannel用的是`SocketChannel.write()`方法，该方法以一个Buffer作为参数

	String newData = "New String to write to file..." + System.currentTimeMillis();
	
	ByteBuffer buf = ByteBuffer.allocate(48);
	buf.clear();
	buf.put(newData.getBytes());
	
	buf.flip();
	
	while(buf.hasRemaining()) {
	    channel.write(buf);
	}

`SocketChannel.write()`方法的调用是在一个while循环中的。`Write()`方法无法保证能写多少字节到SocketChannel。所以，我们重复调用`write()`直到Buffer没有要写的字节为止。

#### 非阻塞模式

可以设置SocketChannel为非阻塞模式（non-blocking mode）。设置之后，就可以在异步模式下调用`connect()`, `read()`和`write()`了。

##### connect（）

如果SocketChannel在非阻塞模式下，此时调用`connect()`，该方法可能在连接建立之前就返回了。为了确定连接是否建立，可以调用`finishConnect()`的方法。

	socketChannel.configureBlocking(false);
	socketChannel.connect(new InetSocketAddress("http://jenkov.com", 80));
	
	while(! socketChannel.finishConnect() ){
	    //wait, or do something else...
	}

##### write()

非阻塞模式下，`write()`方法在尚未写出任何内容时可能就返回了。所以需要在循环中调用`write()`

##### read()

非阻塞模式下，`read()`方法在尚未读取到任何数据时可能就返回了。所以需要关注它的int返回值，它会告诉你读取了多少字节。

### ServerSocketChannel

	ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
	
	serverSocketChannel.socket().bind(new InetSocketAddress(9999));
	
	while(true){
	    SocketChannel socketChannel =
	            serverSocketChannel.accept();
	
	    //do something with socketChannel...
	}

##### 打开ServerSocketChannel

通过调用`ServerSocketChannel.open()`方法来打开ServerSocketChannel

	ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();

##### 关闭ServerSocketChannel

	serverSocketChannel.close();

##### 监听新进来的连接

通过`ServerSocketChannel.accept()`方法监听新进来的连接。当`accept()`方法返回的时候,它返回一个包含新进来的连接的 SocketChannel。因此, `accept()`方法会一直阻塞到有新连接到达

通常不会仅仅只监听一个连接,在while循环中调用 accept()方法

	while(true){
	    SocketChannel socketChannel =
	            serverSocketChannel.accept();
	
	    //do something with socketChannel...
	}

#### 非阻塞模式

ServerSocketChannel可以设置成非阻塞模式。在非阻塞模式下，`accept()`方法会立刻返回，如果还没有新进来的连接,返回的将是null。 因此，需要检查返回的SocketChannel是否是null.

	ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
	
	serverSocketChannel.socket().bind(new InetSocketAddress(9999));
	serverSocketChannel.configureBlocking(false);
	
	while(true){
	    SocketChannel socketChannel = serverSocketChannel.accept();
	
	    if(socketChannel != null){
	        //do something with socketChannel...
	    }
	}



#### Reference

http://ifeve.com/socket-channel/